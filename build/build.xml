<?xml version="1.0" encoding="UTF-8"?>

<project name="Codeshelf" default="build.all" basedir="..">

	<description>
		Codeshelf build script.
    </description>

	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="${basedir}/build/lib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<!-- Optional add this file to override any of the properties below -->
	<property file="${basedir}/build/build.properties" />
	<property file="${basedir}/conf/version.properties" />

	<!-- Setup the full version property correctly -->
	<if>
		<equals arg1="${version.date}" arg2="none" />
		<then>
			<property name="version" value="${version.major}.${version.revision}" />
			<property name="version.filename" value="${version.major}_${version.revision}" />
		</then>
		<else>
			<property name="version" value="${version.major}.${version.revision} (${version.branch}-${version.commit} ${version.date})" />
			<property name="version.filename" value="${version.major}_${version.revision}_${version.commit}" />
		</else>
	</if>

	<description>CodeShelf Build</description>
	<!--set global properties for this build-->
	<property name="src" location="${basedir}/src" />
	<property name="libs.dir" location="${basedir}/lib" />
	<property name="libs.dist.dir" location="${basedir}/lib/dist" />
	<property name="libs.native.dir" location="${basedir}/lib/native" />
	<property name="libs.test.dir" location="${libs.dir}/junit" />
	<property name="keystore" location="${basedir}/build/keystore" />
	<property name="target" location="${basedir}/target" />
	<property name="target.build" location="${target}/build" />
	<property name="target.compiled.classes" location="${target.build}/compiled-classes" />
	<property name="target.classes" location="${target.compiled.classes}" />
	<property name="target.enhanced.classes" location="${target.build}/enhanced-classes" />
	<property name="target.resources" location="${target.build}/resources" />
	<property name="target.lib" location="${target.build}/lib" />
	<property name="target.native.dir" location="${target.lib}/native" />
	<property name="target.docs" location="${target.build}/docs" />
	<property name="target.docsapi" location="${target.docs}/api" />
	<property name="target.test" location="${target}/test" />
	<property name="target.report" location="${target}/report" />
	<property name="test.dir" location="${basedir}/test" />
	<property name="bin" location="${target.build}/bin" />
	<property name="conf.dir" location="${basedir}/conf" />
	<property name="resources.dir" location="${basedir}/resources" />

	<property name="javac.compile.using.version" value="1.7" />

	<property name="appjar.build.dir" value="${target}/appjar" />

	<property name="ebean.build.dir" value="${basedir}/build" />
	<property name="ebean.lib.dir" value="${ebean.build.dir}/lib" />

	<!-- Define the compile set -->
	<path id="compile-libs">
		<fileset dir="${target.lib}" includes="*.jar" />
	</path>
	<path id="test-libs">
		<fileset dir="${libs.test.dir}" includes="*.jar" />
	</path>

	<!-- clean =================================================================================== -->
	<target name="clean" description="Deletes files generated during the build.">
		<!--Delete created directory trees-->
		<delete includeemptydirs="true" failonerror="false" verbose="false" includes="*.* .*">
			<fileset dir="${target}" followsymlinks="false" />
		</delete>
	</target>

	<!-- init =================================================================================== -->
	<target name="init">
		<!-- Check for min build requirements -->
		<condition property="ant.not.ok" value="true">
			<not>
				<or>
					<contains string="${ant.version}" substring="1.6" />
					<contains string="${ant.version}" substring="1.7" />
					<contains string="${ant.version}" substring="1.8" />
					<contains string="${ant.version}" substring="1.9" />
				</or>
			</not>
		</condition>
		<condition property="java.not.ok" value="true">
			<not>
				<or>
					<contains string="${ant.java.version}" substring="1.7" />
					<contains string="${ant.java.version}" substring="1.8" />
				</or>
			</not>
		</condition>
		<fail if="ant.not.ok" message="Must use Ant 1.6.x, 1.7.x, or 1.8.x to build CodeShelf" />
		<fail if="java.not.ok" message="Must use JDK 1.7.x or higher to build CodeShelf" />

		<!-- Platform-specific initializations -->
		<condition property="windows">
			<os family="windows" />
		</condition>
		<condition property="unix">
			<os family="unix" />
		</condition>
		<condition property="solaris">
			<os name="SunOS" />
		</condition>
		<condition property="linux">
			<os name="Linux" />
		</condition>
		<condition property="osx">
			<os name="Mac OS X" />
		</condition>

		<!--creates the build directory-->
		<mkdir dir="${target}" />
		<mkdir dir="${target.compiled.classes}" />
		<mkdir dir="${target.enhanced.classes}" />
		<mkdir dir="${target.build}" />
		<mkdir dir="${target.resources}" />
		<mkdir dir="${target.lib}" />
		<mkdir dir="${target.native.dir}" />
		<mkdir dir="${target.docs}" />

	</target>

	<!-- resources =================================================================================== -->
	<target name="resources">
		<!--copy todir="${target.resources}">
			<fileset dir="${resources.dir}">
				<exclude name="*.bat" />
				<exclude name="settings.xml" />
				<include name="*.*" />
			</fileset>
		</copy-->
		<copy todir="${target.resources}/conf">
			<fileset dir="${conf.dir}">
				<include name="commons-logging.properties" />
				<include name="ebean.properties" />
				<include name="log4j.properties" />
				<include name="logging.properties" />
				<include name="version.properties" />
			</fileset>
		</copy>
		<!--copy todir="${target.resources}/images">
			<fileset dir="${resources.dir}/images">
				<include name="*.*" />
			</fileset>
		</copy-->
		<!--copy todir="${target.resources}/sounds">
			<fileset dir="${resources.dir}/sounds">
				<include name="*.*" />
			</fileset>
		</copy-->
	</target>

	<!-- build =================================================================================== -->
	<target name="compile" depends="init, resources">

		<copy todir="${target.lib}">
			<fileset dir="${libs.dist.dir}">
				<include name="**/*.*" />
			</fileset>
		</copy>
		<copy todir="${target.native.dir}">
			<fileset dir="${libs.native.dir}">
				<include name="*/**.*" />
			</fileset>
		</copy>
		<!--copy todir="${target.lib}">
			<fileset dir="${basedir}/build/lib">
				<include name="i4jruntime.jar" />
			</fileset>
		</copy-->

		<echo message="${toString:compile-libs}" />

		<!--Compiles the java code from ${src} directory into ${target.compiled.classes} directory-->
		<javac destdir="${target.compiled.classes}" sourcepath="" source="${javac.compile.using.version}" target="${javac.compile.using.version}" verbose="false" compiler="modern" debug="true">
			<classpath>
				<!--pathelement location="${orm-classes.dir}" /-->
				<path refid="compile-libs" />
			</classpath>
			<src path="${src}" />
			<exclude name="org/**/*.java" />
		</javac>

		<!-- Put the FlyweightController classes into the compiled classes folder, so that we can enhance them. -->
		<!--unjar dest="${target.compiled.classes}">
			<patternset>
				<include name="com/gadgetworks/**/*.class" />
			</patternset>
		</unjar-->

		<!-- Put the main application classes in one JAR. -->
		<jar duplicate="fail" jarfile="${target.lib}/codeshelf-unobfs.jar">
			<!-- codeshelf classes (exclude any org.xxx classes) -->
			<fileset dir="${target.compiled.classes}">
				<exclude name="org/**/*.class" />
			</fileset>
		</jar>
	</target>

	<!-- enhance =================================================================================== -->
	<target name="ebean-enhance" description="Enhance classes">

		<echo message="===================================================================" />
		<echo message="Enhancing the MODULE files" />
		<echo message="===================================================================" />

		<!-- define the task enhancer -->
		<taskdef name="ebeanEnhance" classname="com.avaje.ebean.enhance.ant.AntEnhanceTask">
			<classpath>
				<pathelement location="${ebean.lib.dir}/avaje-ebeanorm-agent-3.2.3-SNAPSHOT.jar" />
				<pathelement location="${target.classes}" />
				<path refid="compile-libs" />
			</classpath>
		</taskdef>

		<!-- enhance -->
		<echo>"${target.enhanced.classes}"</echo>
		<ebeanEnhance packages="com.gadgetworks.codeshelf.model.domain" classDestination="x${target.enhanced.classes}" classSource="${target.classes}" transformargs="debug=1" classpath="${target.lib}/*.jar" />

	</target>

	<!-- sign-jars-dist =================================================================================== -->
	<target name="sign-jars-dist">
		<echo level="info">Signing JARS...</echo>
		<!--<signjar jar="${target.lib}/base.jar" keystore="${keystore}" alias="myself" storepass="password" />-->
		<signjar keystore="${keystore}" alias="myself" storepass="password">
			<fileset dir="${libs.dist.dir}">
				<include name="**/*.jar" />
			</fileset>
		</signjar>
	</target>

	<!-- javadocs =================================================================================== -->
	<target name="release.javadocs" depends="javadocs" description="creates javadocs version for developer source builds">
	</target>

	<!-- javadocs =================================================================================== -->
	<target name="javadocs" depends="init">
		<mkdir dir="${target.docsapi}" />
		<javadoc destdir="${target.docsapi}" author="true" version="true" use="true" windowtitle="API for Agent">
			<classpath>
				<path refid="agent.dependencies" />
			</classpath>
			<fileset dir="${src}" defaultexcludes="yes">
				<exclude name="**/*.properties" />
				<exclude name="**/*.html" />
			</fileset>
		</javadoc>
	</target>

	<!-- Jar builder =================================================================================== -->
	<target name="prep.jar" depends="clean, compile">

		<mkdir dir="${appjar.build.dir}" />
		<mkdir dir="${appjar.build.dir}/lib" />

		<copy todir="${appjar.build.dir}/lib">
			<fileset dir="${target.lib}">
				<include name="**/*.jar" />
				<exclude name="**/codeshelf-unobfs.jar" />
				<exclude name="**/datamodels.jar" />
			</fileset>
			<fileset dir="${target.lib}/native" />
		</copy>

		<copy todir="${appjar.build.dir}/lib/native">
			<fileset dir="${target.lib}/native" />
		</copy>

		<antcall target="ebean-enhance" />

		<!-- Prep the CLASSPATH variable for the manifest. -->
		<fileset id="jardir" dir="${target.lib}">
			<include name="**/*.jar" />
		</fileset>
		<pathconvert pathsep=" " property="jarpaths" refid="jardir">
			<map from="${target.lib}" to="lib" />
		</pathconvert>
		<echo>JARPATH: ${jarpaths}</echo>
	</target>

	<!-- Jar helper =================================================================================== -->
	<target name="jar.it">

		<!-- Create the final application JAR file. -->
		<jar duplicate="fail" jarfile="${appjar.build.dir}/${codeshelf.app.jar.name}">
			<zipfileset dir="${target.enhanced.classes}" />
			<zipfileset dir="${target.resources}/">
				<exclude name="**/server.config.properties*" />
				<exclude name="**/sitecontroller.config.properties*" />
			</zipfileset>
			<zipfileset dir="${target.classes}/">
				<exclude name="com.gadgetworks.codeshelf.model.domain/**.*" />
			</zipfileset>

			<manifest>
				<attribute name="Class-Path" value=". ${jarpaths}" />
				<attribute name="Main-Class" value="${main.class}" />
				<attribute name="Built-By" value="Codeshelf, Inc. (www.codeshelf.com)" />
			</manifest>
		</jar>
		<copy todir="${appjar.build.dir}">
			<fileset dir="${target.lib}">
				<include name="${codeshelf.app.jar.name}" />
			</fileset>
		</copy>
	</target>

	<!-- JAR the server  =================================================================================== -->
	<target name="jar.server">
		<property name="codeshelf.app.jar.name" value="server.codeshelf.jar" />
		<property name="main.class" value="com.gadgetworks.codeshelf.application.ServerMain" />
		<antcall target="jar.it" />
	</target>

	<!-- JAR the site controller  =================================================================================== -->
	<target name="jar.sitecontroller">
		<property name="codeshelf.app.jar.name" value="sitecontroller.codeshelf.jar" />
		<property name="main.class" value="com.gadgetworks.codeshelf.application.CsSiteControllerMain" />
		<antcall target="jar.it" />
	</target>

	<target name="build.all" depends="prep.jar" description="Build the server app as a launchable jar">
		<antcall target="jar.server" />
		<antcall target="jar.sitecontroller" />
	</target>

	<target name="deploy-production" depends="prep.jar, jar.server">
		<!--input message="SCP password:" addproperty="scp.password">
			<!- -handler classname="org.apache.tools.ant.input.SecureInputHandler" /- ->
		</input-->

		<echo>App dir: ${appjar.build.dir}</echo>

		<!-- Stop the codeshelf service. -->
		<!--sshexec host="login.codeshelf.io"
			username="codeshelf"
			keyfile="${user.home}/.ssh/codeshelf"
			command="/sbin/stop codeshelf"/-->

		<scp todir="codeshelf@test.codeshelf.com:/opt/codeshelf/engine" verbose="true" keyfile="${user.home}/.ssh/codeshelf">
			<fileset dir="${appjar.build.dir}">
				<include name="**" />
				<include name="**/*" />
				<exclude name="*sitecontroller*.jar" />
				<modified>
					<param name="cache.cachefile" value="${basedir}/build/engine.scp.cache" />
				</modified>
			</fileset>
		</scp>

		<!-- Start the codeshelf service. -->
		<!--sshexec host="login.codeshelf.io"
			username="codeshelf"
			keyfile="${user.home}/.ssh/codeshelf"
			command="/sbin/stop codeshelf"/-->

	</target>

        <!--Compiles the JUnit tests ${test.dir} directory into ${target.test} directory-->
	<target name="compile.junit">
		<mkdir dir="${target.test}" />
	        <javac destdir="${target.test}" sourcepath="" source="${javac.compile.using.version}" target="${javac.compile.using.version}" verbose="false" compiler="modern" debug="true">
        	        <classpath>
                	        <path refid="compile-libs" />
				<path refid="test-libs" />
        	        </classpath>
                	<src path="${test.dir}" />
	        </javac>
			<copy todir="${target.test}">
			  <fileset dir="${test.dir}">
				<include name="**/resource/*"/>
			  </fileset>
			</copy>
	</target>


	<target name="junit" depends="build.all, compile.junit">
		<mkdir dir="${target.report}" />
		<junit printsummary="on" fork="true" haltonfailure="no" failureproperty="test.failed">
			<classpath>
				<pathelement location="${target.classes}" />
				<pathelement location="${target.test}" />
				<pathelement location="${target.lib}" />
				<path refid="compile-libs" />
				<path refid="test-libs" />
			</classpath>
			<formatter type="xml" />
			<batchtest todir="${target.report}" >
				<fileset dir="${test.dir}">
					<include name="**/*Test.java" />
				</fileset>
			</batchtest>
		</junit>
		<fail message="JUnit test case failure detected, check results." if="test.failed" />
	</target>

</project>
